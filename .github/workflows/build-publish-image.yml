name: Build & publish multi-arch image (Spring Boot build-image)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          - linux/arm64

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "24"
          cache: maven

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Needed to build non-native arch on the GitHub runner
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Provides buildx + builder instance (also used by imagetools later)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute arch tag suffix
        id: vars
        shell: bash
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          ARCH="${{ matrix.platform }}"
          ARCH="${ARCH#linux/}"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "arch=$ARCH" >> "$GITHUB_OUTPUT"

      - name: Build & push arch image with Spring Boot build-image
        run: |
          ./mvnw -B -DskipTests spring-boot:build-image \
            -Dspring-boot.build-image.publish=true \
            -Dspring-boot.build-image.imagePlatform=${{ matrix.platform }} \
            -Dspring-boot.build-image.imageName=${{ steps.vars.outputs.image }}:${{ github.sha }}-${{ steps.vars.outputs.arch }}

  manifest:
    runs-on: ubuntu-latest
    needs: [ build-and-push ]

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx (for imagetools)
        uses: docker/setup-buildx-action@v3

      - name: Create and push multi-arch manifests
        shell: bash
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          SHA="${{ github.sha }}"

          PLATFORMS=("linux/amd64" "linux/arm64")

          IMAGES=()
          for p in "${PLATFORMS[@]}"; do
            arch="${p#linux/}"
            IMAGES+=("$IMAGE:$SHA-$arch")
          done

          # Multi-arch tag for this commit
          docker buildx imagetools create \
            -t "$IMAGE:$SHA" \
            "${IMAGES[@]}"

          # Optional: update "latest" (only on main branch)
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker buildx imagetools create \
              -t "$IMAGE:latest" \
              "${IMAGES[@]}"
          fi

          # Optional: if this is a tag push (e.g. v1.2.3), also publish that tag
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            docker buildx imagetools create \
              -t "$IMAGE:$TAG" \
              "${IMAGES[@]}"
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: [ manifest ]

    steps:
      - name: Trigger deployment on Coolify
        run: |
          curl --request GET '${{ secrets.COOLIFY_WEBHOOK }}' --header 'Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}'
